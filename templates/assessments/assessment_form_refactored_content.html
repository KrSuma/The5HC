{% load i18n %}

<!-- This is the content-only version for HTMX navigation -->

<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">
                    {% if is_edit %}평가 수정{% else %}새 평가 작성{% endif %}
                </h1>
                {% if client %}
                    <p class="text-gray-600 mt-2">
                        회원: <span class="font-semibold">{{ client.name }}</span>
                    </p>
                {% endif %}
            </div>
            <div class="flex space-x-4">
                <a href="{% url 'assessments:list' %}" 
                   hx-get="{% url 'assessments:list' %}"
                   hx-target="body"
                   hx-swap="innerHTML"
                   class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    취소
                </a>
            </div>
        </div>
    </div>

    <!-- Refactored Form Demo Notice -->
    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">리팩토링된 폼 구조 데모</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <p>이 페이지는 새로운 모듈식 폼 구조를 시연합니다. AssessmentWithTestsForm이 개별 테스트 폼들을 조정하여 더 나은 코드 구조를 제공합니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment Form -->
    <div class="bg-white shadow-lg rounded-lg">
        <form method="post" hx-post="{% if is_edit %}{% url 'assessments:edit_refactored' assessment.pk %}{% else %}{% url 'assessments:add_refactored' %}{% if client %}?client={{ client.pk }}{% endif %}{% endif %}"
              hx-target="body" hx-swap="innerHTML" class="p-6"
              x-data="refactoredAssessmentForm()">
            {% csrf_token %}
            
            <!-- Step 1: Basic Information -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">1. 기본 정보</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Assessment Form Fields -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">평가 날짜</label>
                        {{ form.assessment_form.date }}
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">테스트 환경</label>
                        {{ form.assessment_form.test_environment }}
                    </div>
                    
                    <div x-show="testEnvironment === 'outdoor'" x-transition>
                        <label class="block text-sm font-medium text-gray-700 mb-2">온도 (°C)</label>
                        {{ form.assessment_form.temperature }}
                    </div>
                </div>
            </div>

            <!-- Step 2: Individual Tests (Simplified for demo) -->
            <div class="space-y-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">2. 개별 테스트 (데모)</h2>
                
                <!-- Form Benefits Display -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">폼 구조 개선 사항</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium text-gray-800 mb-2">이전 구조</h4>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>• 단일 1,494줄 AssessmentForm</li>
                                <li>• 모든 테스트 필드가 하나의 폼에 혼재</li>
                                <li>• 복잡한 검증 로직</li>
                                <li>• 새 테스트 추가 시 전체 폼 수정</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-800 mb-2">개선된 구조</h4>
                            <ul class="text-sm text-gray-600 space-y-1">
                                <li>• 개별 테스트별 독립된 폼 (50-100줄)</li>
                                <li>• AssessmentWithTestsForm으로 조정</li>
                                <li>• 테스트별 특화된 검증</li>
                                <li>• 모듈식 확장 가능</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Demo Form Section -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">개별 테스트 폼 예시</h3>
                    <p class="text-gray-600 mb-4">
                        실제 환경에서는 각 테스트가 별도의 폼 클래스로 관리되어 더 나은 코드 구조를 제공합니다.
                    </p>
                    
                    <!-- Sample form structure display -->
                    <div class="bg-code p-4 rounded-lg text-sm font-mono">
                        <div class="text-green-600 mb-2"># Individual test forms structure:</div>
                        <div class="text-blue-600">form.test_forms = {</div>
                        <div class="ml-4 text-gray-700">
                            'overhead_squat': OverheadSquatTestForm(),<br>
                            'push_up': PushUpTestForm(),<br>
                            'balance': SingleLegBalanceTestForm(),<br>
                            'toe_touch': ToeTouchTestForm(),<br>
                            # ... more test forms
                        </div>
                        <div class="text-blue-600">}</div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="mt-8 flex justify-end space-x-4">
                <button type="button" 
                        hx-get="{% url 'assessments:list' %}"
                        hx-target="body"
                        hx-swap="innerHTML"
                        class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                    취소
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    데모 완료
                </button>
            </div>
        </form>
    </div>

    <!-- Technical Implementation Details -->
    <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-lg p-6">
        <h3 class="text-lg font-medium text-yellow-800 mb-3">기술적 구현 세부사항</h3>
        <div class="text-sm text-yellow-700 space-y-2">
            <p><strong>AssessmentService 통합:</strong> 비즈니스 로직이 서비스 레이어로 이동하여 폼은 UI 관심사에만 집중</p>
            <p><strong>개별 모델 활용:</strong> OverheadSquatTest, PushUpTest 등 새로 생성된 모델들과 직접 연동</p>
            <p><strong>검증 로직 개선:</strong> 각 테스트별로 특화된 clean() 메서드와 검증 규칙</p>
            <p><strong>재사용성 향상:</strong> BaseTestForm을 상속하여 공통 기능 재사용</p>
        </div>
    </div>
</div>

<!-- Alpine.js state management for form interactions -->
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('refactoredAssessmentForm', () => ({
        testEnvironment: 'indoor',
        manualOverrides: {},
        
        init() {
            console.log('Refactored assessment form (HTMX content) initialized');
        },
        
        updateTemperatureVisibility() {
            console.log('Test environment changed to:', this.testEnvironment);
        },
        
        onManualScoreChange(testType, value) {
            this.manualOverrides[testType] = value !== '' && value !== null;
            console.log('Manual override for', testType, ':', this.manualOverrides[testType]);
        }
    }));
});
</script>